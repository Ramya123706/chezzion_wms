{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <div class="card shadow-lg border-0 rounded">
    <div class="card-header bg-dark text-white text-center">
      <h2><i class="fas fa-file-invoice-dollar"></i> Purchase Order Entry</h2>
    </div>
    <div class="card-body">
      <!-- Success & Error Messages -->
      {% if success %}
      <div class="alert alert-success text-center">✅ Purchase uploaded successfully!</div>
      {% endif %} {% if error %}
      <div class="alert alert-danger text-center">❌ {{ error }}</div>
      {% endif %}

      <form method="post" action="{% url 'add_purchase' %}">
        {% csrf_token %}

        <!-- Company & Order Details -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-warning text-dark text-center">
            <h5><i class="fas fa-building"></i> Company & Purchase Order Details</h5>
          </div>
          <div class="card-body row">
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-building"></i> <b>Company Name:</b></label>
              <input type="text" name="company_name" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-calendar-alt"></i> <b>Date:</b></label>
              <input type="date" name="po_date" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-map-marker-alt"></i> <b>Company Address:</b></label>
              <input type="text" name="company_address" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-file-alt"></i> <b>PO No.:</b></label>
              <input type="text" name="po_number" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-phone"></i> <b>Phone Number:</b></label>
              <input type="text" name="company_phone" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-user-tie"></i> <b>Supplier:</b></label>
              <input type="text" name="customer_number" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-globe"></i> <b>Website:</b></label>
              <input type="text" name="company_website" class="form-control" />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-envelope"></i> <b>Email Address:</b></label>
              <input type="email" name="company_email" class="form-control" required />
            </div>
          </div>
        </div>

        <!-- Vendor Information -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-warning text-dark text-center">
            <h5><i class="fas fa-truck"></i> Vendor Information</h5>
          </div>
          <div class="card-body row">
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-id-badge"></i> <b>Contact Name:</b></label>
              <input type="text" name="vendor_contact_name" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-building"></i> <b>Company Name:</b></label>
              <input type="text" name="vendor_company_name" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-map-marker-alt"></i> <b>Address:</b></label>
              <input type="text" name="vendor_address" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-phone-alt"></i> <b>Phone Number:</b></label>
              <input type="text" name="vendor_phone" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-globe"></i> <b>Website:</b></label>
              <input type="text" name="vendor_website" class="form-control" />
            </div>
            <div class="col-md-6 mb-3">
              <label><i class="fas fa-envelope"></i> <b>Email Address:</b></label>
              <input type="email" name="vendor_email" class="form-control" required />
            </div>
          </div>
        </div>

        <!-- Product Information -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-boxes"></i> Product Details</h5>
            <button type="button" class="btn btn-sm btn-primary" id="addProductRow">➕ Add Product</button>
          </div>
          <div class="card-body" id="productRows">
            <div class="row product-entry mb-3">
              <div class="col-md-2">
                <label><i class="fas fa-barcode"></i> <b>Item #</b></label>
                <input type="text" name="item_number[]" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label><i class="fas fa-tag"></i> <b>Product</b></label>
                <input type="text" name="product_name[]" class="form-control" required />
              </div>
              <div class="col-md-2">
                <label><i class="fas fa-sort-numeric-up"></i> <b>Qty</b></label>
                <input type="number" name="quantity[]" class="form-control qty" min="1" required />
              </div>
              <div class="col-md-2">
                <label><i class="fas fa-rupee-sign"></i> <b>Unit Price</b></label>
                <input type="number" step="0.01" name="unit_price[]" class="form-control price" required />
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-danger btn-sm remove-product">✖</button>
              </div>
            </div>
          </div>
          <div class="card-footer text-end">
            <h5 class="mb-0">Grand Total: <span id="grandTotal">0.00</span> ₹</h5>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-success px-4 py-2"><i class="fas fa-paper-plane"></i> Submit Purchase Order</button>
          <a href="{% url 'purchase_list' %}" class="btn btn-secondary px-4 py-2"> <i class="fas fa-arrow-left"></i> Back to List </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />

<script>
  function updateTotals() {
    let grandTotal = 0;
    document.querySelectorAll(".product-entry").forEach((row) => {
      const qty = parseFloat(row.querySelector(".qty")?.value) || 0;
      const price = parseFloat(row.querySelector(".price")?.value) || 0;
      grandTotal += qty * price;
    });
    document.getElementById("grandTotal").innerText = grandTotal.toFixed(2);
  }

  // Add new product row
  document.getElementById("addProductRow").addEventListener("click", function () {
    const container = document.getElementById("productRows");
    const newRow = document.createElement("div");
    newRow.classList.add("row", "product-entry", "mb-3");
    newRow.innerHTML = `
      <div class="col-md-2">
        <input type="text" name="item_number[]" class="form-control" placeholder="Item #" required>
      </div>
      <div class="col-md-4">
        <input type="text" name="product_name[]" class="form-control" placeholder="Product" required>
      </div>
      <div class="col-md-2">
        <input type="number" name="quantity[]" class="form-control qty" min="1" required>
      </div>
      <div class="col-md-2">
        <input type="number" step="0.01" name="unit_price[]" class="form-control price" required>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="button" class="btn btn-danger btn-sm remove-product">✖</button>
      </div>
    `;
    container.appendChild(newRow);
  });

  // Remove product row
  document.addEventListener("click", function (e) {
    if (e.target && e.target.classList.contains("remove-product")) {
      e.target.closest(".product-entry").remove();
      updateTotals();
    }
  });

  // Auto-update totals
  document.addEventListener("input", function (e) {
    if (e.target.classList.contains("qty") || e.target.classList.contains("price")) {
      updateTotals();
    }
  });
</script>
{% endblock %}
