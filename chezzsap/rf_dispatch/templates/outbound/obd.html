{% extends 'base.html' %} {% block content %}
<div class="container mt-4">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-header bg-primary text-white text-center">
      <h4><i class="fas fa-truck"></i> Outbound Delivery Form</h4>
    </div>
    <div class="card-body">
      <form method="post" id="outboundForm">
        {% csrf_token %} {% if form.errors %}
        <div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> {{ form.errors }}</div>
        {% endif %}

        <!-- Delivery & SO -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="dlv_no" class="form-label"><i class="fas fa-hashtag"></i> Delivery Number</label>
            <input type="text" class="form-control" id="dlv_no" name="delivery_no" value="{{ delivery_no }}" readonly />
          </div>
          <div class="col-md-6 mb-3">
            <label for="so_order" class="form-label"><i class="fas fa-file-invoice"></i> SO No</label>
            <select name="so_no" id="so_order" class="form-select">
              <option value="">-- Select SO No --</option>
              {% for so in sales_orders %}
              <option value="{{ so.id }}">{{ so.so_no }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Warehouse & Customer -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="whs_no" class="form-label"><i class="fas fa-warehouse"></i> Warehouse</label>
            <input type="text" class="form-control" id="whs_no" name="whs_no" readonly />
          </div>
          <div class="col-md-6 mb-3">
            <label for="whs_address" class="form-label"><i class="fas fa-map-marker-alt"></i> Warehouse Address</label>
            <input type="text" class="form-control" id="whs_address" name="whs_address" readonly />
          </div>
        </div>

        <!-- Material Table -->
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center" id="deliveryTable">
            <thead class="table-primary">
              <tr>
                <th><i class="fas fa-list-ol"></i> Item No</th>
                <th><i class="fas fa-barcode"></i> Product ID</th>
                <th><i class="fas fa-tag"></i> Product Name</th>
                <th><i class="fas fa-barcode"></i> Serial No</th>
                <th><i class="fas fa-boxes"></i> Batch No</th>
                <th><i class="fas fa-cubes"></i> Qty Ordered</th>
                <th><i class="fas fa-dolly"></i> Qty Issued</th>
                <th><i class="fas fa-dollar-sign"></i> Unit Price</th>
                <th><i class="fas fa-coins"></i> Unit Total</th>
                <th><i class="fas fa-money-check-alt"></i> Net Price</th>
                <th><i class="fas fa-trash-alt"></i></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="text" class="form-control" name="dlv_it_no[]" /></td>
                <td><input type="text" class="form-control" name="product_id[]" /></td>
                <td><input type="text" class="form-control" name="product_name[]" /></td>
                <td><input type="text" class="form-control" name="serial_no[]" /></td>
                <td><input type="text" class="form-control" name="batch_no[]" /></td>
                <td><input type="text" class="form-control" name="qty_order[]" /></td>
                <td><input type="text" class="form-control" name="qty_issued[]" /></td>
                <td><input type="text" class="form-control" name="unit_price[]" /></td>
                <td><input type="text" class="form-control" name="total_unit_price[]" readonly /></td>
                <td><input type="text" class="form-control" name="net_price[]" readonly /></td>
                <td>
                  <button type="button" class="btn btn-danger btn-sm removeRow"><i class="fas fa-trash-alt"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
          <button type="button" class="btn btn-secondary mb-3" id="addRowBtn"><i class="fas fa-plus"></i> Add Row</button>
        </div>

        <!-- Customer Details -->
        <h5 class="mt-4"><i class="fas fa-user"></i> Customer Details</h5>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="customer_id" class="form-label">Sold To</label>
            <input type="text" class="form-control" id="customer_id" name="customer_id" readonly />
          </div>
          <div class="col-md-4 mb-3">
            <label for="ship_to" class="form-label">Ship To</label>
            <input type="text" class="form-control" id="ship_to" />
          </div>
          <div class="col-md-4 mb-3">
            <label for="cust_ref" class="form-label">Customer Reference</label>
            <input type="text" class="form-control" id="cust_ref" />
          </div>
        </div>

        <!-- Dates -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="ord_date" class="form-label"><i class="fas fa-calendar-alt"></i> Order Date</label>
            <input type="text" class="form-control" id="ord_date" name="ord_date" readonly />
          </div>
          <div class="col-md-6 mb-3">
            <label for="del_date" class="form-label"><i class="fas fa-calendar-check"></i> Delivery Date</label>
            <input type="text" class="form-control" id="del_date" name="del_date" readonly />
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end mt-3">
          <button type="submit" class="btn btn-success me-2"><i class="fas fa-save"></i> Save Delivery</button>
          <a href="{% url 'home' %}" class="btn btn-danger"><i class="fas fa-times"></i> Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const soOrder = document.getElementById("so_order");
    const tableBody = document.querySelector("#deliveryTable tbody");
    const addRowBtn = document.getElementById("addRowBtn");
    const form = document.getElementById("outboundForm");

    // Add Row
    addRowBtn.addEventListener("click", function () {
      const newRow = document.createElement("tr");
      newRow.innerHTML = `
      <td><input type="text" class="form-control" name="dlv_it_no[]"></td>
      <td><input type="text" class="form-control" name="product_id[]"></td>
      <td><input type="text" class="form-control" name="product_name[]"></td>
      <td><input type="text" class="form-control" name="serial_no[]"></td>
      <td><input type="text" class="form-control" name="batch_no[]"></td>
      <td><input type="text" class="form-control" name="qty_order[]"></td>
      <td><input type="text" class="form-control" name="qty_issued[]"></td>
      <td><input type="text" class="form-control" name="unit_price[]"></td>
      <td><input type="text" class="form-control" name="total_unit_price[]" readonly></td>
      <td><input type="text" class="form-control" name="net_price[]" readonly></td>
      <td><button type="button" class="btn btn-danger btn-sm removeRow"><i class="fas fa-trash-alt"></i></button></td>
    `;
      tableBody.appendChild(newRow);
    });

    // Remove Row
    tableBody.addEventListener("click", function (e) {
      if (e.target.closest(".removeRow")) {
        e.target.closest("tr").remove();
      }
    });

    // Auto calculate totals
    tableBody.addEventListener("input", function (e) {
      const row = e.target.closest("tr");
      if (!row) return;
      const qtyIssued = parseFloat(row.querySelector('[name="qty_issued[]"]').value) || 0;
      const unitPrice = parseFloat(row.querySelector('[name="unit_price[]"]').value) || 0;
      row.querySelector('[name="total_unit_price[]"]').value = (qtyIssued * unitPrice).toFixed(2);
      row.querySelector('[name="net_price[]"]').value = (qtyIssued * unitPrice).toFixed(2);
    });

    // Normalize empty inputs before submit
    form.addEventListener("submit", function () {
      tableBody.querySelectorAll("tr").forEach((row) => {
        row.querySelectorAll("input").forEach((input) => {
          if (!input.value) input.value = "";
        });
      });
    });

    // Fetch SO Data
    soOrder.addEventListener("change", function () {
      const soId = this.value;
      if (!soId) return;
      tableBody.innerHTML = "";

      fetch(`/get-so-products/${soId}/`)
        .then((res) => res.json())
        .then((data) => {
          data.salesorder.forEach((p) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td><input type="text" class="form-control" name="dlv_it_no[]" value="${p.dlv_it_no || ""}" readonly></td>
            <td><input type="text" class="form-control" name="product_id[]" value="${p.product_id}" readonly></td>
            <td><input type="text" class="form-control" name="product_name[]" value="${p.product_name}" readonly></td>
            <td><input type="text" class="form-control" name="serial_no[]"></td>
            <td><input type="text" class="form-control" name="batch_no[]"></td>
            <td><input type="text" class="form-control" name="qty_order[]" value="${p.qty_order}" readonly></td>
            <td><input type="text" class="form-control" name="qty_issued[]"></td>
            <td><input type="text" class="form-control" name="unit_price[]" value="${p.unit_price}" readonly></td>
            <td><input type="text" class="form-control" name="total_unit_price[]" readonly></td>
            <td><input type="text" class="form-control" name="net_price[]" readonly></td>
            <td><button type="button" class="btn btn-danger btn-sm removeRow"><i class="fas fa-trash-alt"></i></button></td>
          `;
            tableBody.appendChild(row);
          });

          document.getElementById("whs_no").value = data.so_data.whs_no || "";
          document.getElementById("whs_address").value = data.so_data.whs_address || "";
          document.getElementById("customer_id").value = data.so_data.customer_id || "";
          document.getElementById("ord_date").value = data.so_data.order_date || "";
          document.getElementById("del_date").value = data.so_data.delivery_date || "";
        });
    });
  });
</script>
{% endblock %}
