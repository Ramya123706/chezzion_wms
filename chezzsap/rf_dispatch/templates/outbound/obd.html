{% extends 'base.html' %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h3 class="text-white bg-primary text-center mb-3">Outbound Delivery Form</h3>
            <form method="post">
                {% csrf_token %}
                {% if form.errors %}
                <div class="alert alert-danger">
                    {{ form.errors }}
                </div>
                {% endif %}	
                
                <!-- Delivery & SO -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="dlv_no" class="form-label">Delivery Number</label>
                        <input type="text" class="form-control" id="dlv_no" name="delivery_no" value="{{ delivery_no }}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="so_order" class="form-label"><b>SO No</b></label>
                        <select name="so_no" id="so_order" class="form-select">
                            <option value="">Select SO No</option>
                            {% for so in sales_orders %}
                                <option value="{{ so.id }}">{{ so.so_no }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Warehouse & Storage -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="whs_no" class="form-label">Warehouse</label>
                        <input type="text" class="form-control" id="whs_no" name="whs_no" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="whs_address" class="form-label">Warehouse address</label>
                        <input type="text" class="form-control" id="whs_address" name="whs_address" readonly>
                    </div>
                </div>

                <!-- Material Table -->
                <table class="table table-bordered" id="deliveryTable">
                    <thead class="table-light">
                        <tr>
                            <th>Delivery item number</th>
                            <th>Product ID</th>
                            <th>Product Name</th>
                            <th>Serial No</th> 
                            <th>Batch No</th> 
                            <th>Qty Ordered</th>
                            <th>Qty Issued</th> 
                            <th>Unit Price</th>
                            <th>Unit Total Price</th>
                            <th>Net Price</th>
                            <th>Volume of Item</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="form-control" name="dlv_it_no[]"></td>
                            <td><input type="text" class="form-control" name="product_id[]"></td>
                            <td><input type="text" class="form-control" name="product_name[]"></td>
                            <td><input type="text" class="form-control" name="serial_no[]"></td>
                            <td><input type="text" class="form-control" name="batch_no[]"></td>
                            <td><input type="text" class="form-control" name="qty_order[]"></td>
                            <td><input type="text" class="form-control" name="qty_issued[]"></td>
                            <td><input type="text" class="form-control" name="unit_price[]"></td>
                            <td><input type="text" class="form-control" name="total_unit_price[]"></td>
                            <td><input type="text" class="form-control" name="net_price[]"></td>
                            <td><input type="text" class="form-control" name="vol_per_item[]"></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn btn-secondary mb-3" onclick="addRow()">Add Row</button>

                <!-- Customer Details -->
                <h4 class="mt-4">Customer Details</h4>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="customer_id" class="form-label">Sold To</label>
                        <input type="text" class="form-control" id="customer_id" name="customer_id" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="ship_to" class="form-label">Ship To</label>
                        <input type="text" class="form-control" id="ship_to">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="cust_ref" class="form-label">Customer Reference</label>
                        <input type="text" class="form-control" id="cust_ref">
                    </div>
                </div>

                <!-- Dates -->
                <div class="col-md-6 mb-3">
                    <label for="ord_date" class="form-label">Order Date</label>
                    <input type="text" class="form-control" id="ord_date" name="ord_date" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="del_date" class="form-label">Delivery Date</label>
                    <input type="text" class="form-control" id="del_date" name="del_date" readonly>
                </div>

                <button type="submit" class="btn btn-primary">Save Delivery</button>
                <a class="btn btn-secondary">Cancel</a>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const soOrder = document.getElementById("so_order");
    const tableBody = document.querySelector('#deliveryTable tbody');

    // Add Row Function
    window.addRow = function() {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control" name="dlv_it_no[]"></td>
            <td><input type="text" class="form-control" name="product_id[]"></td>
            <td><input type="text" class="form-control" name="product_name[]"></td>
            <td><input type="text" class="form-control" name="serial_no[]"></td>
            <td><input type="text" class="form-control" name="batch_no[]"></td>
            <td><input type="text" class="form-control" name="qty_order[]"></td>
            <td><input type="text" class="form-control" name="qty_issued[]"></td>
            <td><input type="text" class="form-control" name="unit_price[]"></td>
            <td><input type="text" class="form-control" name="total_unit_price[]"></td>
            <td><input type="text" class="form-control" name="net_price[]"></td>
            <td><input type="text" class="form-control" name="vol_per_item[]"></td>
        `;
        tableBody.appendChild(newRow);
    }

    // Populate SO data
    function fetchSOData() {
        const soId = this.value;
        if (!soId) return;

        tableBody.innerHTML = ""; // clear table

        fetch(`/get-so-products/${soId}/`)
            .then(response => response.json())
            .then(data => {
                // ---- Fill table rows ----
                data.salesorder.forEach(p => {
                    const newRow = document.createElement("tr");
                    newRow.innerHTML = `
                        <td><input type="text" class="form-control" name="dlv_it_no[]" value="${p.dlv_it_no || ''}" readonly></td>
                        <td><input type="text" class="form-control" name="product_id[]" value="${p.product_id}" readonly></td>
                        <td><input type="text" class="form-control" name="product_name[]" value="${p.product_name}" readonly></td>
                        <td><input type="text" class="form-control" name="serial_no[]"></td>
                        <td><input type="text" class="form-control" name="batch_no[]"></td>
                        <td><input type="text" class="form-control" name="qty_order[]" value="${p.qty_order}" readonly></td>
                        <td><input type="text" class="form-control" name="qty_issued[]"></td>
                        <td><input type="text" class="form-control" name="unit_price[]" value="${p.unit_price}" readonly></td>
                        <td><input type="text" class="form-control" name="unit_total_price[]" value="${p.unit_total_price}" readonly></td>
                        <td><input type="text" class="form-control" name="net_price[]" value="${p.net_price}" readonly></td>
                        <td><input type="text" class="form-control" name="vol_per_item[]"></td>
                    `;
                    tableBody.appendChild(newRow);
                });

                // ---- Fill extra SO-level fields ----
                document.getElementById("whs_no").value = data.so_data.whs_no || "";
                document.getElementById("whs_address").value = data.so_data.whs_address || "";
                document.getElementById("customer_id").value = data.so_data.customer_id || "";
                document.getElementById("ord_date").value = data.so_data.order_date || "";
                document.getElementById("del_date").value = data.so_data.delivery_date || "";

            });
    }

    // Attach event listener to SO dropdown
    soOrder.addEventListener("change", fetchSOData);

});
</script>

{% endblock %}
