{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <!-- LEFT SIDE: Create Bin Form -->
    <div class="col-md-6 mb-4">
      <div class="card shadow">
        <div class="card-header text-white bg-primary d-flex align-items-center">
          <i class="fas fa-boxes me-2"></i>
          <h5 class="mb-0">Create Bin</h5>
        </div>
        <div class="card-body">
          <form method="post" action="{% url 'create_bin' %}" enctype="multipart/form-data">
            {% csrf_token %}
            {% if error %}
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle me-1"></i>
              <strong>Error:</strong> {{ error }}
            </div>
            {% endif %}

            <!-- Bin Type -->
            <div class="mb-3">
              <label for="bin_type"><i class="fas fa-layer-group me-1"></i><b>Bin Type</b></label>
              <input type="text" id="bin_type" name="bin_type" class="form-control" required />
            </div>

            <!-- Capacity -->
            <div class="mb-3">
              <label for="capacity"><i class="fas fa-weight-scale me-1"></i><b>Capacity</b></label>
              <input type="text" id="capacity" name="capacity" class="form-control" required />
            </div>

            <!-- Existing Quantity -->
            <div class="mb-3">
              <label for="existing_quantity"><i class="fas fa-database me-1"></i><b>Existing Quantity</b></label>
              <input type="number" id="existing_quantity" name="existing_quantity" class="form-control" min="0" value="0" required />
            </div>

            <!-- Location -->
            <div class="mb-3">
              <label for="location"><i class="fas fa-map-marker-alt me-1"></i><b>Location</b></label>
              <input type="text" id="location" name="location" class="form-control" required />
            </div>

            <!-- Category -->
            <div class="mb-3">
              <label for="category"><i class="fas fa-tags me-1"></i><b>Category</b></label>
              <select id="category" name="category" class="form-control" required>
                <option value="">-- Select Category --</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.category }}</option>
                {% endfor %}
              </select>
              <button type="button" class="btn btn-link p-0 mt-1" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-plus-circle me-1"></i>Add New Category
              </button>
            </div>

            <!-- Sub Category -->
            <div class="mb-3">
              <label for="subcategory"><i class="fas fa-tag me-1"></i><b>Sub Category</b></label>
              <select id="subcategory" name="subcategory" class="form-control" required>
                <option value="">-- Select Sub Category --</option>
              </select>
            </div>

            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary w-50">
                <i class="fas fa-paper-plane me-1"></i> Submit
              </button>
            </div>
          </form>

          <!-- CSV Upload -->
          <div class="card mt-4 border-success">
            <div class="card-header bg-success text-white">
              <i class="fas fa-file-csv me-1"></i> Bulk Upload Bins (CSV)
            </div>
            <div class="card-body">
              <form method="post" action="{% url 'bulk_upload_bins' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                  <input type="file" name="csv_file" class="form-control" accept=".csv" required />
                </div>
                <button type="submit" class="btn btn-success w-100">
                  <i class="fas fa-upload me-1"></i> Upload
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT SIDE: Bin Cards -->
    <div class="col-md-6">
      <h5 class="mb-3 text-center"><i class="fas fa-th-large me-1"></i>All Bins</h5>
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-layer-group me-1"></i> Bin Zones
        </div>
        <div class="card-body d-flex flex-wrap gap-3">
          {% for bin in bins %}
          <a href="{% url 'bin_detail' bin.id %}" class="card text-decoration-none text-white bg-success shadow-sm" style="width: 100%">
            <div class="card-body text-center p-3">
              <h5 class="card-title">{{ bin.bin_id }}</h5>
              <p class="card-text mb-0">Capacity: {{ bin.capacity }} units</p>
              <div class="d-flex justify-content-center align-items-center">
                <span class="card-text">Existing: {{ bin.existing_quantity }} units</span>
                <span class="card-text text-warning ms-2"><b>Remaining:</b> {{ bin.remaining_capacity }} units</span>
              </div>
              <p class="card-text mb-0">
                <small>Created by:
                  {% if bin.created_by %}
                    {{ bin.created_by.get_full_name|default:bin.created_by.username }}
                  {% else %}
                    N/A
                  {% endif %}
                </small><br>
                <small>Updated by:
                  {% if bin.updated_by %}
                    {{ bin.updated_by.get_full_name|default:bin.updated_by.username }}
                  {% else %}
                    N/A
                  {% endif %}
                </small>
              </p>
            </div>
          </a>
          {% empty %}
          <p class="text-muted">No bins available.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Modal: Add Category -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addCategoryForm" method="POST" action="{% url 'add_category' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryModalLabel">
            <i class="fas fa-plus-circle me-1"></i> Add New Category
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="id_category" class="form-label">Category Name</label>
            <input type="text" name="category" class="form-control" id="id_category" required />
          </div>

          <div class="mb-3">
            <label for="id_description" class="form-label">Description</label>
            <textarea name="description" class="form-control" id="id_description" rows="3"></textarea>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="addSubCategoryCheckbox" />
            <label class="form-check-label" for="addSubCategoryCheckbox">Add Sub Categories</label>
          </div>

          <div class="mb-3 d-none" id="numSubCategoriesDiv">
            <label for="numSubCategories" class="form-label">Number of Sub Categories</label>
            <input type="number" min="1" class="form-control" id="numSubCategories" placeholder="Enter number" />
          </div>

          <div id="subCategoryInputs"></div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Save
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const checkbox = document.getElementById("addSubCategoryCheckbox");
    const numDiv = document.getElementById("numSubCategoriesDiv");
    const numInput = document.getElementById("numSubCategories");
    const subInputsDiv = document.getElementById("subCategoryInputs");

    checkbox.addEventListener("change", function () {
      if (this.checked) numDiv.classList.remove("d-none");
      else {
        numDiv.classList.add("d-none");
        subInputsDiv.innerHTML = "";
      }
    });

    numInput.addEventListener("input", function () {
      subInputsDiv.innerHTML = "";
      const count = parseInt(this.value);
      if (!isNaN(count) && count > 0) {
        for (let i = 1; i <= count; i++) {
          subInputsDiv.innerHTML += `
          <div class="mb-2">
            <label for="sub_category_${i}" class="form-label">Sub Category ${i}</label>
            <input type="text" name="sub_category_${i}" id="sub_category_${i}" class="form-control" required>
          </div>`;
        }
      }
    });

    // AJAX category form submission
    document.getElementById("addCategoryForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      fetch("{% url 'add_category' %}", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value },
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            const select = document.getElementById("category");
            const option = document.createElement("option");
            option.value = data.id;
            option.text = data.category;
            option.selected = true;
            select.appendChild(option);
            bootstrap.Modal.getInstance(document.getElementById("addCategoryModal")).hide();
            this.reset();
            subInputsDiv.innerHTML = "";
            numDiv.classList.add("d-none");
          } else alert(data.message || "Error adding category.");
        });
    });

    // Load subcategories dynamically
    document.getElementById("category").addEventListener("change", function () {
      const categoryId = this.value;
      const subcategorySelect = document.getElementById("subcategory");
      subcategorySelect.innerHTML = '<option value="">-- Select Sub Category --</option>';
      if (categoryId) {
        fetch(`/get-subcategories/${categoryId}/`)
          .then((res) => res.json())
          .then((data) => {
            data.subcategories.forEach((sub) => {
              const option = document.createElement("option");
              option.value = sub.id;
              option.text = sub.name;
              subcategorySelect.appendChild(option);
            });
          });
      }
    });
  });
</script>
{% endblock %}
