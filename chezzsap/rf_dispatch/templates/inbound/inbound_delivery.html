{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Main Form -->
        <div class="col-md-8">
            <h3 class="text-white bg-primary text-center mb-3 p-3 rounded"> 
                <i class="fas fa-truck-loading me-2"></i>Inbound Delivery Form
            </h3>
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i> {{ form.errors }}
                    </div>
                {% endif %}

                <div class="row g-3">
                    <!-- Inbound Delivery Number -->
                    <div class="col-md-6">
                        <label for="inbound_delivery_number" class="form-label"><i class="fas fa-hashtag me-1"></i>Inbound Delivery Number</label>
                        <input type="text" class="form-control" name="inbound_delivery_number"
                               id="inbound_delivery_number" value="{{ delivery.inbound_delivery_number|default:'' }}"
                               placeholder="Auto generated" readonly>
                    </div>

                    <!-- Delivery Date -->
                    <div class="col-md-6">
                        <label for="delivery_date" class="form-label"><i class="fas fa-calendar-alt me-1"></i>Delivery Date</label>
                        <input type="date" class="form-control" name="delivery_date" id="delivery_date"
                               value="{{ delivery.delivery_date|date:'Y-m-d' }}">
                    </div>

                    <!-- Supplier -->
                    <div class="col-md-6">
                        <label for="vendor" class="form-label"><i class="fas fa-industry me-1"></i>Supplier (Vendor)</label>
                        <select name="vendor" id="vendor" class="form-select" required>
                            <option value="">Select Supplier</option>
                            {% for vendor in vendors %}
                                <option value="{{ vendor.vendor_id }}" {% if delivery.vendor_id == vendor.vendor_id %}selected{% endif %}>
                                    {{ vendor.vendor_id }} - {{ vendor.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- PO Number -->
                    <div class="col-md-6">
                        <label for="purchase_order" class="form-label"><i class="fas fa-file-alt me-1"></i>PO No</label>
                        <select name="po_number" id="purchase_order" class="form-select" required>
                            <option value="">Select PO No</option>
                            {% for po in purchase_orders %}
                                <option value="{{ po.id }}" {% if delivery.po_number == po.po_number %}selected{% endif %}>
                                    {{ po.po_number }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- ESN -->
                    <div class="col-md-6">
                        <label for="esn" class="form-label"><i class="fas fa-barcode me-1"></i>ESN</label>
                        <input type="text" class="form-control" name="esn" id="esn" value="{{ delivery.esn|default:'' }}">
                    </div>

                    <!-- Warehouse -->
                    <div class="col-md-6">
                        <label for="whs_no" class="form-label"><i class="fas fa-warehouse me-1"></i>Warehouse</label>
                        <select name="whs_no" id="whs_no" class="form-select" required>
                            <option value="">Select a warehouse</option>
                            {% for wh in warehouses %}
                                <option value="{{ wh.pk }}" {% if delivery.whs_no == wh.pk %}selected{% endif %}>
                                    {{ wh.whs_no }} - {{ wh.whs_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Document Date -->
                    <div class="col-md-6">
                        <label for="document_date" class="form-label"><i class="fas fa-calendar-check me-1"></i>Document Date</label>
                        <input type="date" class="form-control" name="document_date" id="document_date"
                               value="{{ delivery.document_date|date:'Y-m-d' }}">
                    </div>

                    <!-- Delivery Status -->
                    <div class="col-md-6">
                        <label for="delivery_status" class="form-label"><i class="fas fa-clipboard-list me-1"></i>Delivery Status</label>
                        <select class="form-select" name="delivery_status" id="delivery_status">
                            <option value="" disabled>Select status</option>
                            <option value="Pending" {% if delivery.delivery_status == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="Completed" {% if delivery.delivery_status == 'Completed' %}selected{% endif %}>Completed</option>
                        </select>
                    </div>

                    <!-- Material Table -->
                    <div class="col-12">
                        <div class="table-responsive shadow-sm">
                            <table class="table table-bordered table-hover" id="deliveryTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Description</th>
                                        <th>Quantity Delivered</th>
                                        <th>Quantity Received</th>
                                        <th>UOM</th>
                                        <th>Batch Number</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Remarks -->
                    <div class="col-12">
                        <label for="remarks" class="form-label"><i class="fas fa-comment-alt me-1"></i>Remarks</label>
                        <textarea class="form-control" name="remarks" id="remarks" placeholder="Add any notes here...">{{ delivery.remarks|default:'' }}</textarea>
                    </div>

                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-success btn-lg px-5">
                            <i class="fas fa-paper-plane me-2"></i>Submit
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white text-center">
                    <h5 class="mb-0"><i class="fas fa-search me-1"></i>Search Inbound Deliveries</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="ibd_no" class="form-control" placeholder="Search by IBD No."
                                   value="{{ request.GET.ibd_no }}">
                            <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i></button>
                        </div>
                    </form>

                    {% if deliveries %}
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>IBD No.</th>
                                    <th>PO No.</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in deliveries %}
                                    <tr>
                                        <td>{{ entry.delivery_date|date:"Y-m-d" }}</td>
                                        <td>{{ entry.inbound_delivery_number }}</td>
                                        <td>{{ entry.po_number }}</td>
                                        <td>
                                            <a href="{% url 'delivery_detail' entry.inbound_delivery_number %}"
                                               class="btn btn-info btn-sm px-3 py-1">
                                               <i class="fas fa-eye me-1"></i>View
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="alert alert-warning text-center mt-2">
                            <i class="fas fa-exclamation-circle me-1"></i>No deliveries found.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS: Populate products on PO change -->
<!-- ensure these ids exist on the elements:
     id="vendor" (select), id="delivery_date" (input date),
     id="document_date" (input date), id="purchase_order" (select),
     id="deliveryTable" (table)
-->

<!-- JS: Populate products + vendor + dates on PO change -->
<script>
(function(){
    const poSelect = document.getElementById("purchase_order");
    if (!poSelect) return;

    poSelect.addEventListener("change", function() {
        const poId = this.value;
        const tableBody = document.querySelector('#deliveryTable tbody');
        if (!tableBody) return;
        tableBody.innerHTML = "";  // clear previous rows

        if (!poId) return;

        fetch(`/get-po-products/${poId}/`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            // --- Vendor + Dates ---
            if (data.vendor) {
                const vendorSelect = document.getElementById('vendor');
                if (vendorSelect) {
                    // if we have a vendor_id returned and an existing option matches, select it.
                    if (data.vendor.vendor_id) {
                        const vendorIdStr = String(data.vendor.vendor_id);
                        const foundOption = Array.from(vendorSelect.options).some(o => String(o.value) === vendorIdStr);
                        if (foundOption) {
                            vendorSelect.value = vendorIdStr;
                        } else {
                            // create new option (temporary) so it shows selected
                            const opt = document.createElement('option');
                            opt.value = vendorIdStr;
                            opt.text = data.vendor.display || vendorIdStr;
                            vendorSelect.appendChild(opt);
                            vendorSelect.value = vendorIdStr;
                        }
                    } else {
                        // no matching vendor record; create a non-selectable temp option showing vendor name
                        const tempOpt = document.createElement('option');
                        tempOpt.value = '';
                        tempOpt.text = data.vendor.display || '';
                        vendorSelect.appendChild(tempOpt);
                        vendorSelect.value = '';
                    }
                }
            }

            if (data.po_date) {
                const dd = document.getElementById('delivery_date');
                const doc = document.getElementById('document_date');
                if (dd) dd.value = data.po_date;
                if (doc) doc.value = data.po_date;
            }

            // --- Products ---
            if (!data.products || data.products.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="6" class="text-center">No products found for this PO</td>`;
                tableBody.appendChild(row);
                return;
            }

            data.products.forEach(p => {
                const newRow = document.createElement("tr");
                newRow.innerHTML = `
                    <td><input type="text" class="form-control" name="product[]" value="${escapeHtml(p.code)}" readonly></td>
                    <td><input type="text" class="form-control" name="product_description[]" value="${escapeHtml(p.description)}" readonly></td>
                    <td><input type="text" class="form-control" name="quantity_delivered[]" value="${p.quantity}" readonly></td>
                    <td><input type="text" class="form-control" name="quantity_received[]"></td>
                    <td><input type="text" class="form-control" name="unit_of_measure[]" value="${escapeHtml(p.uom)}" readonly></td>
                    <td><input type="text" class="form-control" name="batch_number[]" placeholder="Auto-generated" readonly></td>
                `;
                tableBody.appendChild(newRow);
            });
        })
        .catch(error => {
            console.error('Error fetching PO products:', error);
            const tableBody = document.querySelector('#deliveryTable tbody');
            if (tableBody) {
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="6" class="text-center text-danger">Error fetching products</td>`;
                tableBody.appendChild(row);
            }
        });
    });

    // small helper to avoid XSS via template interpolation
    function escapeHtml(text) {
        if (!text && text !== 0) return '';
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
})();
</script>


{% endblock %}
