{% extends "base.html" %} {% load static %} {% block content %}
<div class="container mt-4">
  <h3 class="mb-4 text-primary"><i class="fas fa-file-invoice"></i> Create Sales Order</h3>

  {% if error %}
  <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <form method="post" id="salesOrderForm">
    {% csrf_token %}

    <!-- Warehouse -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label"><b>Warehouse</b></label>
        <select name="whs_no" id="whs_no" class="form-select" required>
          <option value="">Select Warehouse</option>
          {% for wh in warehouses %}
          <option value="{{ wh.whs_no }}">{{ wh.whs_no }} - {{ wh.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label"><b>Warehouse Address</b></label>
        <input type="text" name="whs_address" id="whs_address" class="form-control" readonly />
      </div>
    </div>

    <!-- Customer -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label"><b>Customer ID</b></label>
        <input type="text" name="customer_id" class="form-control" required />
      </div>
      <div class="col-md-6">
        <label class="form-label"><b>Customer Code</b></label>
        <input type="text" name="customer_code" class="form-control" required />
      </div>
    </div>

    <!-- Dates -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label"><b>Order Date</b></label>
        <input type="date" name="order_date" class="form-control" required />
      </div>
      <div class="col-md-6">
        <label class="form-label"><b>Delivery Date</b></label>
        <input type="date" name="delivery_date" class="form-control" required />
      </div>
    </div>

    <!-- Remarks -->
    <div class="mb-3">
      <label class="form-label"><b>Remarks</b></label>
      <textarea name="remarks" class="form-control"></textarea>
    </div>

    <!-- Product Table -->
    <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
      <h5 class="text-primary m-0"><i class="fas fa-box"></i> Product Details</h5>
      <button type="button" class="btn btn-success btn-sm" onclick="addRow()"><i class="fas fa-plus"></i> Add Product</button>
    </div>

    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Product</th>
          <th>Stock</th>
          <th>Quantity</th>
          <th>Unit Price</th>
          <th>Total Price</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="productTableBody">
        <tr>
          <td style="position: relative">
            <input type="hidden" name="product_id[]" class="product_id" />
            <input type="text" name="product_name[]" class="form-control product_name" autocomplete="off" />
            <div class="suggestions list-group"></div>
          </td>
          <td><input type="text" class="form-control existing_qty" readonly /></td>
          <td><input type="number" name="quantity[]" class="form-control quantity" min="1" value="1" /></td>
          <td><input type="number" name="unit_price[]" class="form-control unit_price" step="0.01" value="0" /></td>
          <td><input type="text" class="form-control total_price" readonly /></td>
          <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">Remove</button></td>
        </tr>
      </tbody>
    </table>

    <!-- Net Total -->
    <div class="mb-3">
      <label class="form-label"><b>Net Total Price</b></label>
      <input type="text" id="net_total_price" name="net_total_price" class="form-control text-end" readonly />
    </div>

    <!-- Submit -->
    <div class="mt-4">
      <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Order</button>
      <a href="{% url 'sales_order_list' %}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<!-- Styles -->
<style>
  .suggestions {
    position: absolute;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    z-index: 1050;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  .suggestions div {
    padding: 8px 12px;
    cursor: pointer;
  }
  .suggestions div:hover {
    background-color: #f8f9fa;
  }
</style>

<!-- Scripts -->
<script>
  function addRow() {
    const tbody = document.getElementById("productTableBody");
    const row = document.createElement("tr");
    row.innerHTML = `
        <td style="position:relative;">
            <input type="hidden" name="product_id[]" class="product_id">
            <input type="text" name="product_name[]" class="form-control product_name" autocomplete="off">
            <div class="suggestions list-group"></div>
        </td>
        <td><input type="text" class="form-control existing_qty" readonly></td>
        <td><input type="number" name="quantity[]" class="form-control quantity" min="1" value="1"></td>
        <td><input type="number" name="unit_price[]" class="form-control unit_price" step="0.01" value="0"></td>
        <td><input type="text" class="form-control total_price" readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">Remove</button></td>
    `;
    tbody.appendChild(row);
    setupAutocomplete(row);
    setupRowEvents(row);
  }

  function removeRow(btn) {
    btn.closest("tr").remove();
    calculateNetTotal();
  }

  function setupAutocomplete(row) {
    const input = row.querySelector(".product_name");
    const productIdInput = row.querySelector(".product_id");
    const existingQtyInput = row.querySelector(".existing_qty");
    const unitPriceInput = row.querySelector(".unit_price");
    const suggestions = row.querySelector(".suggestions");

    input.addEventListener("keyup", function () {
      if (input.value.length === 0) {
        suggestions.innerHTML = "";
        return;
      }
      fetch(`/product-autocomplete/?term=${input.value}`)
        .then((res) => res.json())
        .then((data) => {
          suggestions.innerHTML = "";
          data.forEach((item) => {
            const div = document.createElement("div");
            div.className = "list-group-item list-group-item-action";
            div.textContent = `${item.name} (â‚¹${item.unit_price})`;

            div.addEventListener("click", function () {
              input.value = item.name;
              productIdInput.value = item.id;
              existingQtyInput.value = item.stock || 0;
              unitPriceInput.value = item.unit_price || 0;
              suggestions.innerHTML = "";
              calculateRowTotal(row);
            });

            suggestions.appendChild(div);
          });
        });
    });
  }

  function setupRowEvents(row) {
    row.querySelector(".quantity").addEventListener("input", () => calculateRowTotal(row));
    row.querySelector(".unit_price").addEventListener("input", () => calculateRowTotal(row));
  }

  function calculateRowTotal(row) {
    const qty = parseFloat(row.querySelector(".quantity").value) || 0;
    const price = parseFloat(row.querySelector(".unit_price").value) || 0;
    row.querySelector(".total_price").value = (qty * price).toFixed(2);
    calculateNetTotal();
  }

  function calculateNetTotal() {
    let total = 0;
    document.querySelectorAll(".total_price").forEach((input) => {
      total += parseFloat(input.value) || 0;
    });
    document.getElementById("net_total_price").value = total.toFixed(2);
  }

  // Initialize autocomplete & row events
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("#productTableBody tr").forEach((row) => {
      setupAutocomplete(row);
      setupRowEvents(row);
    });

    // Auto-fill warehouse address
    document.getElementById("whs_no").addEventListener("change", function () {
      const whsNo = this.value;
      if (!whsNo) {
        document.getElementById("whs_address").value = "";
        return;
      }
      fetch(`/get-warehouse-address/${whsNo}/`)
        .then((r) => r.json())
        .then((d) => (document.getElementById("whs_address").value = d.address || "Unknown"));
    });
  });
</script>
{% endblock %}
