{% extends "base.html" %} {% load custom_tags %} {% block content %}
<div class="container mt-5">
  <div class="row g-4">
    <!-- Left side: Add Questions -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Add Inspection Questions</h5>
        </div>
        <div class="card-body">
          {% if not count %}
          <!-- Step 1: Ask number of questions -->
          <form method="POST">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">How many questions?</label>
              <input type="number" name="count" class="form-control" min="1" required />
            </div>
            <button type="submit" class="btn btn-primary w-100">Next</button>
          </form>
          {% else %}
          <!-- Step 2: Show input boxes -->
          <form method="POST">
            {% csrf_token %} {% for i in ""|center:count %}
            <div class="mb-3">
              <label for="question{{ forloop.counter }}"> Question {{ forloop.counter }} </label>
              <input type="text" name="question{{ forloop.counter }}" class="form-control" required />
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-success w-100">Save Questions</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right side: Existing Questions -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-light">
          <h5 class="mb-0">Existing Questions</h5>
        </div>
        <div class="card-body">
          {% if old_questions %}
          <ul class="list-group">
            {% for q in old_questions %}
            <li class="list-group-item d-flex justify-content-between align-items-center m-2">
              <span id="question-text-{{ q.id }}" class="fw-semibold"> {{ q.text }} </span>
              <div class="btn-group">
                <button class="btn btn-outline-warning btn-sm edit-btn" data-id="{{ q.id }}" data-text="{{ q.text }}">
                  <i class="fa fa-pencil"></i>
                </button>
                <a
                  href="{% url 'delete_question' q.id %}"
                  class="btn btn-outline-danger btn-sm"
                  onclick="return confirm('Are you sure you want to delete this question?');">
                  <i class="fa fa-trash"></i>
                </a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="alert alert-secondary text-center m-0">No questions saved yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Edit Question</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="editQuestionInput" class="form-control" autofocus />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="saveEditBtn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let currentId = null;
    let editModal = new bootstrap.Modal(document.getElementById("editModal"));

    // Get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    // Open modal with existing text
    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.addEventListener("click", function () {
        currentId = this.dataset.id;
        document.getElementById("editQuestionInput").value = this.dataset.text;
        editModal.show();
        setTimeout(() => document.getElementById("editQuestionInput").focus(), 500);
      });
    });

    // Save changes
    document.getElementById("saveEditBtn").addEventListener("click", function () {
      let newText = document.getElementById("editQuestionInput").value.trim();
      if (!newText) return alert("Question cannot be empty!");

      fetch(`/edit-question/${currentId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: "text=" + encodeURIComponent(newText),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            document.getElementById("question-text-" + currentId).innerText = data.text;
            editModal.hide();
          } else {
            alert("Error: " + data.error);
          }
        })
        .catch((err) => alert("Request failed: " + err));
    });
  });
</script>
{% endblock %}
