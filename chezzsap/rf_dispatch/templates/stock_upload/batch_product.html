{% extends "base.html" %} {% load static %} {% block content %}
<div class="container mt-5">
  <div class="row g-4">
    <!-- Main Form Column -->
    <div class="col-md-6 col-sm-12 order-md-1">
      <!-- Product Entry Form -->
      <div class="card shadow-lg rounded">
        <div class="card-header bg-primary text-white text-center">
          <h5><i class="fas fa-box-open me-2"></i>Chezzion WMS - Magic Box</h5>
        </div>
        <div class="card-body">
          <form action="{% url 'batch_product' %}" method="post">
            {% csrf_token %}
            <!-- Warehouse -->
            <div class="mb-3">
              <label class="form-label"><i class="fas fa-warehouse me-1"></i><b>Warehouse</b></label>
              <select name="whs_no" class="form-select" required>
                <option value="">Select Warehouse</option>
                {% for wh in warehouse %}
                <option value="{{ wh.whs_no }}">{{ wh.whs_no }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Product Search -->
            <div class="mb-3 position-relative">
              <label for="product_input" class="form-label"><i class="fas fa-search me-1"></i>Product</label>
              <input
                type="text"
                class="form-control"
                id="product_input"
                name="product"
                placeholder="Start typing product ID or name"
                autocomplete="off"
                required />
              <div id="product_suggestions" class="border bg-white position-absolute w-100 shadow-sm" style="z-index: 1000; display: none"></div>
              <small class="form-text text-muted">Can't find your product? <a href="{% url 'add_product' %}">Add New Product</a></small>
            </div>

            <!-- Category & Subcategory -->
            <div class="mb-3">
              <label for="category"><i class="fas fa-tags me-1"></i><b>Category</b></label>
              <select id="category" name="category" class="form-control" required>
                <option value="">-- Select Category --</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.category }}</option>
                {% endfor %}
              </select>
              <button type="button" class="btn btn-link p-0 mt-1" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-plus-circle me-1"></i>Add New Category
              </button>
            </div>

            <div class="mb-3">
              <label for="subcategory"><i class="fas fa-tag me-1"></i><b>Sub Category</b></label>
              <select id="subcategory" name="sub_category" class="form-control" required>
                <option value="">-- Select Sub Category --</option>
              </select>
            </div>

            <!-- BIN & Description -->
            <div class="row g-3 mt-2">
              <div class="mb-3">
              <label for="bin"><i class="fas fa-box me-1"></i><b>Bin</b></label>
              <select id="bin" name="bin" class="form-control" required>
                <option value="">-- Select Bin --</option>
              </select>
            </div>

              <div class="col-md-6">
                <label for="description" class="form-label"><i class="fas fa-file-alt me-1"></i>Description</label>
                <input type="text" id="description" name="description" class="form-control" required />
              </div>
            </div>

            <!-- Quantity & Pallet -->
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label for="quantity" class="form-label"><i class="fas fa-sort-numeric-up me-1"></i>Quantity</label>
                <input type="number" id="quantity" name="quantity" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="pallet" class="form-label"><i class="fas fa-truck-loading me-1"></i>Pallet</label>
                <select id="pallet" name="pallet" class="form-select" required>
                  <option value="">-- Select Pallet --</option>
                  {% for pal in pallet %}
                    <option value="{{ pal.pallet_no }}">{{ pal.pallet_no }} </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- Batch -->
            <div class="mb-3 mt-3">
              <label class="form-label"><i class="fas fa-layer-group me-1"></i>Batch</label><br />
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="batch_option" id="batchYes" value="yes" />
                <label class="form-check-label" for="batchYes">Yes</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="batch_option" id="batchNo" value="no" checked />
                <label class="form-check-label" for="batchNo">No</label>
              </div>
              <div class="mt-2 d-none" id="batchInputDiv">
                <input type="text" class="form-control" id="batchInput" name="batch_input" placeholder="Enter batch value" />
              </div>
            </div>

            <!-- Packing Material & Inspection -->
            <div class="row g-3">
              <div class="col-md-6">
                <label for="p_mat" class="form-label"><i class="fas fa-box me-1"></i>Packing Material</label>
                <select id="p_mat" name="p_mat" class="form-select" required>
                  <option value="">-- Select --</option>
                  {% for mat in materials %}
                  <option value="{{ mat.id }}">{{ mat.material }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="inspection" class="form-label"><i class="fas fa-check-circle me-1"></i>Inspection</label>
                <input type="text" id="inspection" name="inspection" class="form-control" required />
              </div>
            </div>

            <!-- Stock Type & Item Number -->
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label for="stock_type" class="form-label"><i class="fas fa-boxes-stacked me-1"></i>Stock Type</label>
                <select id="stock_type" name="stock_type" class="form-select" required>
                  <option value="Quality">Quality</option>
                  <option value="Blocked">Blocked</option>
                  <option value="Scrapped">Scrapped</option>
                  <option value="Unrestricted" selected>Unrestricted</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="item_number" class="form-label"><i class="fas fa-barcode me-1"></i>Item Number</label>
                <input type="text" id="item_number" name="item_number" class="form-control" required />
              </div>
            </div>

            <!-- Doc No & Pallet Status -->
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label for="doc_no" class="form-label"><i class="fas fa-file-invoice me-1"></i>Doc No</label>
                <input type="text" id="doc_no" name="doc_no" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="pallet_status" class="form-label"><i class="fas fa-clipboard-list me-1"></i>Pallet Status</label>
                <select id="pallet_status" name="pallet_status" class="form-select" required>
                  <option value="">-- Select --</option>
                  <option value="Received">Received</option>
                  <option value="Planned">Planned</option>
                  <option value="Damaged">Damaged</option>
                  <option value="Rejected">Rejected</option>
                </select>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-flex justify-content-center mt-4">
              <button type="submit" class="btn btn-primary w-100"><i class="fas fa-paper-plane me-1"></i>ENTER</button>
            </div>
          </form>
        </div>
      </div>

      <!-- CSV Upload -->
      <div class="card shadow-lg rounded mt-4 p-4">
        <h6><i class="fas fa-file-csv me-1"></i>Bulk Upload via CSV</h6>
        <form method="post" enctype="multipart/form-data" action="{% url 'batch_product_csv_upload' %}">
          {% csrf_token %}
          <div class="input-group mt-2">
            <input type="file" name="csv_file" class="form-control" accept=".csv" required />
            <button class="btn btn-success" type="submit"><i class="fas fa-upload me-1"></i>Upload</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Sidebar Column -->
    <div class="col-md-4 order-md-2">
      <div class="d-flex justify-content-center mb-3">
        <button id="listBtn" class="btn btn-success"><i class="fas fa-list me-1"></i> List</button>
      </div>

      <!-- Search Products -->
      <div class="card shadow rounded">
        <div class="card-header bg-primary text-white text-center">
          <h5 class="mb-0"><i class="fas fa-search me-1"></i>Search Products</h5>
        </div>
        <div class="card-body">
          <form method="get" class="mb-3">
            <div class="input-group">
              <input
                type="text"
                name="product_search"
                class="form-control"
                placeholder="Search by Product ID or Name"
                value="{{ request.GET.product_search }}" />
              <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i></button>
            </div>
          </form>

          {% if stocks %}
          <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Product ID</th>
                  <th>Category</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for stock in stocks %}
                <tr>
                  <td>{{ stock.product_id }}</td>
                  <td>{{ stock.category }}</td>
                  <td>
                    <a href="{% url 'stock_detail' stock.id %}" class="btn btn-sm btn-info px-3 py-1 fs-6"><i class="fas fa-eye me-1"></i>View</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-warning text-center mt-2"><i class="fas fa-exclamation-triangle me-1"></i>No products found.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Bootstrap Modal: Add Category -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addCategoryForm" method="POST" action="{% url 'add_category' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryModalLabel"><i class="fas fa-plus-circle me-1"></i> Add New Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="id_category" class="form-label">Category Name</label>
            <input type="text" name="category" class="form-control" id="id_category" required />
          </div>
          <div class="mb-3">
            <label for="id_description" class="form-label">Description</label>
            <textarea name="description" class="form-control" id="id_description" rows="3"></textarea>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="addSubCategoryCheckbox" />
            <label class="form-check-label" for="addSubCategoryCheckbox">Add Sub Categories</label>
          </div>
          <div class="mb-3 d-none" id="numSubCategoriesDiv">
            <label for="numSubCategories" class="form-label">Number of Sub Categories</label>
            <input type="number" min="1" class="form-control" id="numSubCategories" placeholder="Enter number" />
          </div>
          <div id="subCategoryInputs"></div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- JS -->
<script>
  // Product Suggestions
  const productInput = document.getElementById("product_input");
  const suggestionBox = document.getElementById("product_suggestions");

  productInput.addEventListener("keyup", function () {
    const query = this.value.trim();
    const suggestionBox = document.getElementById("product_suggestions");
    if (query.length > 0) {
      fetch(`/ajax/product-suggestions/?q=${encodeURIComponent(query)}`)
        .then((res) => res.json())
        .then((data) => {
          suggestionBox.innerHTML = "";
          if (data.results.length > 0) {
            data.results.forEach((item) => {
              const div = document.createElement("div");
              div.textContent = `${item.product_id} - ${item.name}`;
              div.classList.add("p-2", "suggestion-item");
              div.style.cursor = "pointer";
              div.onclick = () => {
  document.getElementById("product_input").value = item.product_id;
  document.getElementById("description").value = item.description || "";
  document.getElementById("category").value = item.category || "";
  document.getElementById("subcategory").value = item.sub_category || "";
  suggestionBox.style.display = "none";
};
              suggestionBox.appendChild(div);
            });
            suggestionBox.style.display = "block";
          } else {
            suggestionBox.style.display = "none";
          }
        })
        .catch(() => (suggestionBox.style.display = "none"));
    } else suggestionBox.style.display = "none";
  });

  // Batch Input Toggle
  const batchYes = document.getElementById("batchYes");
  const batchNo = document.getElementById("batchNo");
  const batchInputDiv = document.getElementById("batchInputDiv");

  function toggleBatchInput() {
    if (batchYes.checked) {
      batchInputDiv.classList.remove("d-none");
      batchInputDiv.querySelector("input").focus();
    } else {
      batchInputDiv.classList.add("d-none");
      batchInputDiv.querySelector("input").value = "";
    }
  }
  batchYes.addEventListener("change", toggleBatchInput);
  batchNo.addEventListener("change", toggleBatchInput);

  // Load subcategories dynamically
    document.getElementById("category").addEventListener("change", function () {
      const categoryId = this.value;
      const subcategorySelect = document.getElementById("subcategory");
      subcategorySelect.innerHTML = '<option value="">-- Select Sub Category --</option>';
      if (categoryId) {
        fetch(`/get-subcategories/${categoryId}/`)
          .then((res) => res.json())
          .then((data) =>
            data.subcategories.forEach((sub) => {
              const option = document.createElement("option");
              option.value = sub.id;
              option.text = sub.name;
              subcategorySelect.appendChild(option);
            })
          );
      }
    });

  // Sidebar List button
  document.getElementById("listBtn").addEventListener("click", function () {
    window.location.href = "{% url 'stock_list' %}";
  });

  document.addEventListener("DOMContentLoaded", function () {
    const checkbox = document.getElementById("addSubCategoryCheckbox");
    const numDiv = document.getElementById("numSubCategoriesDiv");
    const numInput = document.getElementById("numSubCategories");
    const subInputsDiv = document.getElementById("subCategoryInputs");

    checkbox.addEventListener("change", function () {
      if (this.checked) numDiv.classList.remove("d-none");
      else {
        numDiv.classList.add("d-none");
        subInputsDiv.innerHTML = "";
      }
    });

    numInput.addEventListener("input", function () {
      subInputsDiv.innerHTML = "";
      const count = parseInt(this.value);
      if (!isNaN(count) && count > 0) {
        for (let i = 1; i <= count; i++) {
          subInputsDiv.innerHTML += `
          <div class="mb-2">
            <label for="sub_category_${i}" class="form-label">Sub Category ${i}</label>
            <input type="text" name="sub_category_${i}" id="sub_category_${i}" class="form-control" required>
          </div>`;
        }
      }
    });

    // AJAX category form submission
    document.getElementById("addCategoryForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      fetch("{% url 'add_category' %}", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value },
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            const select = document.getElementById("category");
            const option = document.createElement("option");
            option.value = data.id;
            option.text = data.category;
            option.selected = true;
            select.appendChild(option);
            bootstrap.Modal.getInstance(document.getElementById("addCategoryModal")).hide();
            this.reset();
            subInputsDiv.innerHTML = "";
            numDiv.classList.add("d-none");
          } else alert(data.message || "Error adding category.");
        });
    });
  }); // <-- Add this closing parenthesis for the DOMContentLoaded function
</script>
<script>
  // Load bins dynamically when subcategory changes
document.getElementById("subcategory").addEventListener("change", function () {
  const subcategoryId = this.value;
  const binSelect = document.getElementById("bin");
  binSelect.innerHTML = '<option value="">-- Select Bin --</option>';

  if (subcategoryId) {
    fetch(`/get-bins/${subcategoryId}/`)
      .then((res) => res.json())
      .then((data) => {
        data.bins.forEach((bin) => {
          const option = document.createElement("option");
          option.value = bin.id;
          option.text = `${bin.bin_id} (Remaining: ${bin.remaining}/${bin.capacity})`;
          binSelect.appendChild(option);
        });
      });
  }
});


</script>
{% endblock %}
