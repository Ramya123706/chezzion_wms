{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row g-4">

        <!-- LEFT SIDE: Add Product -->
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-header text-white bg-primary">
                    <h5 class="mb-0"><i class="fa-solid fa-box me-2"></i> Add Product</h5>
                </div>

                <div class="card-body">
                    <form method="post" action="{% url 'add_product' %}" enctype="multipart/form-data">
                        {% csrf_token %}

                        {% if error %}
                        <div class="alert alert-danger">
                            <i class="fa-solid fa-circle-exclamation me-1"></i>
                            <strong>Error:</strong> {{ error }}
                        </div>
                        {% endif %}

                        <!-- Product Name -->
                        <div class="mb-3">
                            <label for="name" class="form-label">
                                <i class="fa-solid fa-tag me-1"></i> <b>Product Name</b>
                            </label>
                            <input type="text" id="name" name="name" class="form-control" required>
                        </div>

                        <!-- Product ID -->
                      <!-- Product ID (Auto Generated) -->
<div class="mb-3 visually-hidden">
    <label for="product_id" class="form-label">
        <i class="fa-solid fa-barcode me-1"></i> <b>Product ID (Auto)</b>
    </label>
    <input type="text" id="product_id" class="form-control" value="Will be auto-generated" readonly>
</div>

                        <!-- Quantity -->
                        <div class="mb-3">
                            <label for="quantity" class="form-label">
                                <i class="fa-solid fa-cubes me-1"></i> <b>Quantity</b>
                            </label>
                            <input type="text" id="quantity" name="quantity" class="form-control" required>
                        </div>

                        <!-- Pallet -->
                        <div class="mb-3">
                            <label for="pallet_no" class="form-label">
                                <i class="fa-solid fa-pallet me-1"></i> <b>Pallet No</b>
                            </label>
                            <select id="pallet" name="pallet" class="form-select">
                                <option value="">-- Select Pallet --</option>
                                {% for pallet in pallets %}
                                    {% if not pallet.parent_pallet %}
                                        <option value="{{ pallet.id }}">
                                            {{ pallet.pallet_no }} ({{ pallet.child_pallets.count }})
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>




                        </div>

                        <!-- SKU -->
                        <div class="mb-3">
                            <label for="sku" class="form-label">
                                <i class="fa-solid fa-hashtag me-1"></i> <b>SKU</b>
                            </label>
                            <input type="text" id="sku" name="sku" class="form-control" required>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="description" class="form-label">
                                <i class="fa-solid fa-align-left me-1"></i> <b>Description</b>
                            </label>
                            <input type="text" id="description" name="description" class="form-control" required>
                        </div>

                        <!-- Unit of Measure -->
                        <div class="mb-3">
                            <label for="unit_of_measure" class="form-label">
                                <i class="fa-solid fa-ruler me-1"></i> <b>Unit of Measure</b>
                            </label>
                            <input type="text" id="unit_of_measure" name="unit_of_measure" class="form-control"
                                required>
                        </div>

                        <!-- Category -->
                        <div class="mb-3">
                            <label for="category" class="form-label">
                                <i class="fa-solid fa-list me-1"></i> <b>Category</b>
                            </label>
                            <select id="category" name="category" class="form-select" required>
                                <option value="">-- Select Category --</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.category }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Subcategory -->
                        <div class="mb-3">
                            <label for="subcategory" class="form-label">
                                <i class="fa-solid fa-list-ul me-1"></i> <b>Sub Category</b>
                            </label>
                            <select id="subcategory" name="sub_category_id" class="form-select">
                                <option value="">-- Select Subcategory --</option>
                                {% for sub in subcategories %}
                                <option value="{{ sub.id }}" {% if form.sub_category.value == sub.id|stringformat:"s" %}selected{% endif %}>
                                    {{ sub.name }}
                                </option>

                                {% endfor %}
                            </select>
                        </div>

                        <!-- Reorder Level -->
                        <div class="mb-3">
                            <label for="re_order_level" class="form-label">
                                <i class="fa-solid fa-bell me-1"></i> <b>Reorder Level</b>
                            </label>
                            <input type="text" id="re_order_level" name="re_order_level" class="form-control" required>
                        </div>

                        <!-- Unit Price -->
                        <div class="mb-3">
                            <label for="unit_price" class="form-label">
                                <i class="fa-solid fa-indian-rupee-sign me-1"></i> <b>Unit Price</b>
                            </label>
                            <input type="number" step="0.01" id="unit_price" name="unit_price" class="form-control"
                                required>
                        </div>

                        <!-- Image -->
                        <div class="mb-3">
                            <label for="images" class="form-label">
                                <i class="fa-solid fa-image me-1"></i> <b>Image</b>
                            </label>
                            <input type="file" id="images" name="images" class="form-control" accept="image/*">
                        </div>

                        <!-- Submit -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa-solid fa-plus-circle me-1"></i> Submit
                            </button>
                        </div>
                    </form>

                    <!-- Bulk Upload -->
                    <div class="card mt-4 border-0 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fa-solid fa-file-csv me-2"></i> Bulk Upload Products (CSV)</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{% url 'bulk_upload_products' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="csv_file" class="form-label">
                                        <i class="fa-solid fa-upload me-1"></i> <b>Select CSV File</b>
                                    </label>
                                    <input type="file" id="csv_file" name="csv_file" class="form-control" accept=".csv"
                                        required>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fa-solid fa-cloud-arrow-up me-1"></i> Upload CSV
                                </button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- RIGHT SIDE: Search and Display -->
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-secondary text-white text-center">
                    <h5 class="mb-0"><i class="fa-solid fa-magnifying-glass me-2"></i> Search Products</h5>
                </div>

                <div class="p-4 text-center">
                    <a href="{% url 'product_list' %}" class="btn btn-outline-secondary mb-3">
                        <i class="fa-solid fa-table-list me-1"></i> View All Products
                    </a>

                    <!-- Search Form -->
                    <form method="get" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="search" class="form-control" placeholder="ðŸ” Enter product number">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa-solid fa-search me-1"></i> Search
                            </button>
                        </div>
                    </form>
                </div>

                {% if products %}
                <!-- Desktop Table View -->
                <div class="d-none d-md-block px-3 pb-3">
                    <table class="table table-bordered text-center align-middle">
                        <thead class="table-light">
                            <tr>
                                <th><i class="fa-solid fa-barcode me-1"></i> Product ID</th>
                                <th><i class="fa-solid fa-box-open me-1"></i> Name</th>
                                <th><i class="fa-solid fa-gear me-1"></i> Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr>
                                <td>{{ product.product_id }}</td>
                                <td>{{ product.name }}</td>
                                <td>
                                    <a href="{% url 'product_detail' product.product_id %}" class="btn btn-sm btn-info">
                                        <i class="fa-solid fa-eye me-1"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Card View -->
                <div class="d-md-none px-3 pb-3">
                    {% for product in products %}
                    <div class="card mb-3 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fa-solid fa-barcode me-1"></i> Product #{{ product.product_id }}
                            </h5>
                            <p class="card-text mb-1">
                                <i class="fa-solid fa-box me-1"></i> <strong>Name:</strong> {{ product.name }}
                            </p>
                            <a href="{% url 'product_detail' product.product_id %}" class="btn btn-sm btn-info">
                                <i class="fa-solid fa-eye me-1"></i> View
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% else %}
                <!-- No Results -->
                <div class="alert alert-warning text-center m-3">
                    <i class="fa-solid fa-triangle-exclamation me-1"></i> No products found matching your search.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- JS for Subcategory -->
<script>
    document.getElementById("category").addEventListener("change", function () {
        const categoryId = this.value;
        const subcategorySelect = document.getElementById("subcategory");

        subcategorySelect.innerHTML = '<option value="">-- Select Subcategory --</option>';

        if (categoryId) {
            fetch(`/ajax/load-subcategories/?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    data.subcategories.forEach(sub => {
                        const option = document.createElement("option");
                        option.value = sub.id;
                        option.text = sub.name;
                        subcategorySelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Error loading subcategories:", error));
        }
    });
</script>
<script>
document.getElementById("quantity").addEventListener("change", function() {
    const qty = parseInt(this.value);
    const palletSelect = document.getElementById("pallet");
    palletSelect.innerHTML = '<option value="">-- Select Pallet --</option>';

    if (qty > 0) {
        fetch(`/ajax/suggest-pallets/?quantity=${qty}`)
        .then(res => res.json())
        .then(data => {
            if (data.pallets.length > 0) {
                data.pallets.forEach(p => {
                    const option = document.createElement("option");
                    option.value = p.id;
                    option.text = `${p.pallet_no} (${p.child_count} child pallets)`;
                    palletSelect.appendChild(option);
                });
            } else {
                const option = document.createElement("option");
                option.text = "Not enough pallets, create new";
                option.value = "create_new";
                palletSelect.appendChild(option);
            }
        });
    }
});
</script>

{% endblock %}