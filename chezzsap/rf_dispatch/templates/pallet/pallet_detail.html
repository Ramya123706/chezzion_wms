{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
      <h5 class="mb-0"><i class="fa-solid fa-boxes me-2"></i>Pallet Details - {{ pallet.pallet_no }}</h5>
      <div>
        <a href="{% url 'edit_pallet' pallet.pallet_no %}" class="btn btn-sm btn-outline-light me-1">
          <i class="fa-solid fa-pen-to-square"></i> Edit
        </a>
        <button
          class="btn btn-sm btn-outline-danger"
          data-bs-toggle="modal"
          data-bs-target="#deleteModal"
          data-pallet="{{ pallet.pallet_no }}"
          data-children="{% for child in pallet.child_pallets.all %}{{ child.pallet_no }}{% if not forloop.last %}, {% endif %}{% endfor %}">
          <i class="fa-solid fa-trash"></i> Delete
        </button>
        {% if not pallet.parent_pallet %}
        <button class="btn btn-sm btn-outline-success" onclick="openChildModal('{{ pallet.pallet_no }}')">
          <i class="fa-solid fa-plus"></i> Add Child
        </button>
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      <table class="table table-bordered table-hover">
        <tr>
          <th>Pallet No</th>
          <td>{{ pallet.pallet_no }}</td>
        </tr>
        <tr>
          <th>Parent Pallet</th>
          <td>{% if pallet.parent_pallet %}{{ pallet.parent_pallet.pallet_no }}{% else %}None{% endif %}</td>
        </tr>
        <tr>

          <th>Product</th>
          <td>{% if pallet.product %}{{ pallet.product.name }}{% else %}None{% endif %}</td>
        </tr>
        <tr>
          <th>P Mat</th>
          <td>{{ pallet.p_mat }}</td>
        </tr>
        <tr>
          <th>Quantity</th>
          <td>{{ pallet.quantity }}</td>
        </tr>
        <tr>
          <th>Weight</th>
          <td>{{ pallet.weight }}</td>
        </tr>
        <tr>
          <th>Created By</th>
          <td>{{ pallet.created_by }}</td>
        </tr>
        <tr>
          <th>Created At</th>
          <td>{{ pallet.created_at }}</td>
        </tr>
        <tr>
          <th>Child Pallets</th>
          <td>
            {% if child_pallets %}
            <ul class="list-group list-group-flush">
              {% for child in child_pallets %}
              <li class="list-group-item">
                <i class="fa-solid fa-box me-1"></i>
                <a href="{% url 'pallet_detail' child.pallet_no %}">{{ child.pallet_no }}</a>
              </li>
              {% endfor %}
            </ul>
            {% else %} None {% endif %}
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>

<!-- Child Pallet Modal -->
<div class="modal fade" id="childModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow-sm">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="fa-solid fa-plus me-1"></i> Add Child Pallets</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="childForm" method="POST" action="{% url 'add_child_pallet' %}">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="parent_pallet" id="parentPalletInput" />
          <div class="mb-3">
            <label class="form-label">Number of Child Pallets</label>
            <input type="number" name="num_children" class="form-control" min="1" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success"><i class="fa-solid fa-check me-1"></i> Create</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fa-solid fa-xmark me-1"></i> Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow-sm">
      <form id="deleteForm" method="post">
        {% csrf_token %}
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="fa-solid fa-triangle-exclamation me-1"></i> Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this pallet?</p>
          <p><strong>Child Pallets:</strong></p>
          <ul id="childList" class="list-group list-group-flush"></ul>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger"><i class="fa-solid fa-trash me-1"></i> Yes, Delete</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fa-solid fa-xmark me-1"></i> Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function openChildModal(parentPallet) {
    document.getElementById("parentPalletInput").value = parentPallet;
    new bootstrap.Modal(document.getElementById("childModal")).show();
  }

  var deleteModal = document.getElementById("deleteModal");
  deleteModal.addEventListener("show.bs.modal", function (event) {
    var button = event.relatedTarget;
    var palletId = button.getAttribute("data-pallet");
    var children = button.getAttribute("data-children").split(", ");

    var form = deleteModal.querySelector("#deleteForm");
    form.action = "/pallet/delete/" + palletId + "/";

    var childList = document.getElementById("childList");
    childList.innerHTML = "";
    if (children[0] !== "") {
      children.forEach(function (child) {
        var li = document.createElement("li");
        li.textContent = child;
        li.classList.add("list-group-item");
        childList.appendChild(li);
      });
    } else {
      childList.innerHTML = "<li class='list-group-item'>No child pallets</li>";
    }
  });
</script>
{% endblock %}
